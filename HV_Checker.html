<!DOCTYPE html>
<html lang="ja">

<head>
  <title>Harvest Checker</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="style.css" type="text/css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="./js/jquery-3.6.3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
  <style>
    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      background-color: rgb(255, 252, 195);
    }

    .container_hv {
      text-align: center;
      height: 100vh;
      /* ç”»é¢ã®é«˜ã•ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
      padding-top: 100px;
    }
  </style>
</head>

<body>
  <div class="container_hv">
    <h4>Harvest Checker <br><br>ğŸŒ¾ğŸŒ¾ğŸŒ¾ğŸŒ¾ğŸŒ¾</h4>
    <br>
    <input type="text" id="addr" style="font-size: 25px" placeholder="Symbolã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›" />
    <br>
    <br>
    <br>
    <br>
    <button type="button" class="btn-gradient-radius" onclick="harvest_checker();"
      style="font-size: 30px; cursor: pointer">START</button>
    <br>
    <br>
    <div id="kurukuru_re"></div>


    <br>
    <div id="hv_status" style="font-size: 30px;"></div>
    <br>
    <div id="importance" style="font-size: 30px;font-family: 'Itim', cursive;"></div>
    <br>
    <div id="hv_node" style="font-size: 30px;font-family: 'Itim', cursive;"></div>
    <br>
    <br>
    <br>
    <div id="version">Powerd by SYMBOL<br><a href='https://x.com/mikunNEM'><small>@mikunNEM</small></a></div>

  </div>


  <script type="text/javascript" src="https://xembook.github.io/nem2-browserify/symbol-sdk-pack-2.0.4.js"></script>

  <script>

    const NODE = new Array('https://symbol.cryptobeliever.net:3001', 'https://symbol-mikun.net:3001', 'https://symbol-main-1.nemtus.com:3001', 'https://sym-main-03.opening-line.jp:3001');
    let URL;

    function harvest_checker() {

      const hv_status = document.getElementById('hv_status');
      hv_status.innerHTML = "";  // åˆæœŸåŒ–
      const dom_importance = document.getElementById('importance');  // ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ³ã‚¹è¡¨ç¤º
      dom_importance.innerHTML = "";  // åˆæœŸåŒ–
      const hv_node = document.getElementById('hv_node');
      hv_node.innerHTML = "";  // åˆæœŸåŒ–

      dispLoading();  // ã‚¯ãƒ«ã‚¯ãƒ«è¡¨ç¤º 

      getActiveNode().then(result => {  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ¼ãƒ‰ã‚’æ¸¡ã™
        console.log("getActiveNode æˆ»ã‚Šå€¤ : ", result);
        URL = result;

        const sym = require('/node_modules/symbol-sdk');
        const repo = new sym.RepositoryFactoryHttp(URL);
        const accountRepo = repo.createAccountRepository();
        const totalChainImportance = 78429286;                // https://symbol-mikun.net:3001/network/properties    ( "totalChainImportance":"7'842'928'625'000'000" )
        const networkType = 104;

        let addr = document.getElementById('addr').value;

        addr = addr.replace(/-/g, "");  // ãƒã‚¤ãƒ•ãƒ³ã‚’å‰Šé™¤ã™ã‚‹
        addr = addr.replace(/ /g, "");  // ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤
        addr = addr.replace(/ã€€/g, ""); //ã€€ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤     

        if (addr.length !== 39) {  // ã‚¢ãƒ‰ãƒ¬ã‚¹æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯
          swal(`Address Error!!`, "æ­£ã—ã„æ–‡å­—æ•°ã¯39æ–‡å­—ã§ã™").then(() => { removeLoading() });
          return;
        }

        if (addr.charAt(0) !== "N") {
          swal('Address Error !!', "ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã®å…ˆé ­ã¯ã€ŒNã€ã§ã™").then(() => { removeLoading() });
          return;
        }

        address = sym.Address.createFromRawAddress(addr);

        accountRepo.getAccountInfo(address)
          .toPromise()
          .catch(() => swal(`Address Error!!`, "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«èªè­˜ã•ã‚Œã¦ã„ãªã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™").then(() => { removeLoading() }))
          .then((accountInfo) => {
            console.log("accountInfo=", accountInfo)
            console.log("account_Mosaics =", accountInfo.mosaics.length);

            let accountImportance = Number(accountInfo.importance.toString()) / totalChainImportance;
            if (accountImportance > 0) {
              accountImportance = Math.round(accountImportance);
              accountImportance /= 1000000;
            }
            if (accountImportance === 0) {
              removeLoading(); // ã‚¯ãƒ«ã‚¯ãƒ«éè¡¨ç¤º
              swal(`Importance Error!!`, "ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ³ã‚¹ãŒæœ‰ã‚Šã¾ã›ã‚“");
              return;
            }

            dom_importance.innerHTML = `<div style="text-align: center;padding-top: 8px"><font color="green">ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ³ã‚¹<br>${accountImportance} ï¼…</font></div>`;

            let data;
            let data2;
            let data3;

            if (accountInfo.supplementalPublicKeys.linked !== undefined) {  //  account pubkey ãŒã‚ã‚‹å ´åˆ
              const account_linked_pubkey = accountInfo.supplementalPublicKeys.linked.publicKey;
              //console.log("account_linked_pubkey===============",account_linked_pubkey);

              if (accountInfo.supplementalPublicKeys.node !== undefined) {   //  node pubkey ãŒã‚ã‚‹å ´åˆ   ï¼ˆå§”ä»»å…ˆã®ãƒãƒ¼ãƒ‰ã‚ªãƒ¼ãƒŠãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã¯ãªã„å ´åˆï¼‰
                const node_pubkey = accountInfo.supplementalPublicKeys.node.publicKey;
                //console.log("node_pubkey===============",node_pubkey);

                console.log(" ==== å§”ä»»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ====");

                fetch(`https://symbol.services/nodes/nodePublicKey/${node_pubkey}`) // static services ã‹ã‚‰ã€€node publicKey æƒ…å ±ã‚’å–å¾—                     
                  .then((response) => {
                    if (!response.ok) {
                      swal(`Fetch Error!!`, `https://symbol.services/nodes/nodePublicKey/${node_pubkey}
                   
                   * nodePublicKey ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
                   
                   å§”ä»»å…ˆãƒãƒ¼ãƒ‰ãŒåœæ­¢ã—ã¦ã„ã‚‹ã‹ã€ãƒ¢ãƒã‚¤ãƒ«ãƒãƒ¼ãƒ‰(peer node ã¯æœªå¯¾å¿œ)ã®ãŸã‚æ¤œç´¢å‡ºæ¥ã¾ã›ã‚“`);
                      removeLoading(); // ã‚¯ãƒ«ã‚¯ãƒ«éè¡¨ç¤º  
                      throw new Error(`Network response was not ok: ${response.status}`);
                    }
                    return response.json();
                  })
                  .then((data) => {

                    console.log("%cå§”ä»»å…ˆãƒãƒ¼ãƒ‰è©³ç´°=", "color: red", data);  // 

                    fetch(`https://${data.host}:3001/node/unlockedaccount`)    // unlockedaccount ãƒªãƒ³ã‚¯ã•ã‚ŒãŸå…¬é–‹éµã‚’å–å¾—
                      .then((response2) => {
                        if (!response2.ok) {
                          throw new Error(`Network response was not ok: ${response2.status}`);
                        }
                        return response2.json();
                      })
                      .then((data2) => {
                        delegate_list(URL, data2, sym, networkType); // å§”ä»»è€…ãƒªã‚¹ãƒˆè¡¨ç¤º(symboladdress)
                        if (searchArray(data2.unlockedAccount, account_linked_pubkey)) {
                          console.log(`æœ‰åŠ¹ğŸŸ¢`);
                          hv_status.innerHTML = `ğŸŸ¢ æœ‰åŠ¹`
                          hv_node.innerHTML = `å§”ä»»å…ˆãƒãƒ¼ãƒ‰<br>${data.host}<br><br>å§”ä»»è€…æ•°<br>${data2.unlockedAccount.length}`
                          removeLoading(); // ã‚¯ãƒ«ã‚¯ãƒ«éè¡¨ç¤º
                        } else {
                          console.log(`ç„¡åŠ¹ğŸ”´`);
                          hv_status.innerHTML = `ğŸ”´ ç„¡åŠ¹ `
                          removeLoading(); // ã‚¯ãƒ«ã‚¯ãƒ«éè¡¨ç¤º
                          swal(`Link Error!!`, "å§”ä»»å…ˆãƒãƒ¼ãƒ‰ã¨ãƒªãƒ³ã‚¯ã—ã¦ã„ã¾ã›ã‚“");
                        }
                      })
                      .catch((error) => {
                        console.error("Fetch error:", error);
                      });
                  })
                  .catch((error) => {
                    console.error("Fetch error:", error);
                  });


              } else { // node pubkey  ãŒç„¡ã„å ´åˆ (ãƒãƒ¼ãƒ‰ã‚ªãƒ¼ãƒŠãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å ´åˆ) //////////////////////////////////
                if (accountInfo.supplementalPublicKeys.vrf !== undefined) {  //  vrf pubkey ãŒã‚ã‚‹å ´åˆ
                  console.log(" ==== ãƒãƒ¼ãƒ‰ã‚ªãƒ¼ãƒŠãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ====");

                  fetch(`https://symbol.services/nodes/${accountInfo.publicKey}`)
                    .then((response) => {
                      if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.status}`);
                      }
                      return response.json();
                    })
                    .then((data) => {

                      console.log("%cå§”ä»»å…ˆãƒãƒ¼ãƒ‰è©³ç´°=", "color: red", data);

                      fetch(`https://${data.host}:3001/node/unlockedaccount`)   // unlockedaccount ãƒªãƒ³ã‚¯ã•ã‚ŒãŸå…¬é–‹éµã‚’å–å¾—
                        .then((response2) => {
                          if (!response2.ok) {
                            throw new Error(`Network response was not ok: ${response2.status}`);
                          }
                          return response2.json();
                        })
                        .then((data2) => {
                          delegate_list(URL, data2, sym, networkType); // å§”ä»»è€…ãƒªã‚¹ãƒˆè¡¨ç¤º(symboladdress)                                                                                                         
                          if (searchArray(data2.unlockedAccount, account_linked_pubkey)) {
                            console.log(`æœ‰åŠ¹ğŸŸ¢`);
                            hv_status.innerHTML = `ğŸŸ¢ æœ‰åŠ¹`
                            hv_node.innerHTML = `å§”ä»»å…ˆãƒãƒ¼ãƒ‰<br>${data.host}<br><br>å§”ä»»è€…æ•°<br>${data2.unlockedAccount.length}`
                            removeLoading(); // ã‚¯ãƒ«ã‚¯ãƒ«éè¡¨ç¤º
                          } else {
                            console.log(`ç„¡åŠ¹ğŸ”´`);
                            hv_status.innerHTML = `ğŸ”´ ç„¡åŠ¹ `
                            removeLoading(); // ã‚¯ãƒ«ã‚¯ãƒ«éè¡¨ç¤º
                            swal(`Link Error!!`, "å§”ä»»å…ˆãƒãƒ¼ãƒ‰ã¨ãƒªãƒ³ã‚¯ã—ã¦ã„ã¾ã›ã‚“");
                          }
                        })
                        .catch((error) => {
                          console.error("Fetch error:", error);
                        });
                    })
                    .catch((error) => {
                      console.error("Fetch error:", error);
                    });
                } else {    // vrf pubkey ãŒç„¡ã„å ´åˆ
                  hv_status.innerHTML = `ğŸ”´ ç„¡åŠ¹ `
                  removeLoading(); // ã‚¯ãƒ«ã‚¯ãƒ«éè¡¨ç¤º
                  swal(`Link Error!!`, "å§”ä»»å…ˆãƒãƒ¼ãƒ‰ã¨ãƒªãƒ³ã‚¯ã—ã¦ã„ã¾ã›ã‚“");
                }
              }
            } else {
              hv_status.innerHTML = `ğŸ”´ ç„¡åŠ¹ `
              removeLoading(); // ã‚¯ãƒ«ã‚¯ãƒ«éè¡¨ç¤º
              swal(`Link Error!!`, "å§”ä»»å…ˆãƒãƒ¼ãƒ‰ã¨ãƒªãƒ³ã‚¯ã—ã¦ã„ã¾ã›ã‚“");
            }

          }); // accountRepo        
      });  //  getActiveNode()
    }    //  harvest_checker()

    async function getActiveNode() { // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ¼ãƒ‰ã‚’æ¢ã™ //////////////////////////

      for (let i = 0; i < NODE.length; i++) {
        try {
          // Fetchãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
          const response = await fetch(`${NODE[i]}/node/health`);

          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹åˆ¤å®š
          if (!response.ok) {
            throw new Error('HTTPã‚¨ãƒ©ãƒ¼ ' + response.status);
          } else {
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’JSONã¨ã—ã¦è§£æ
            const data = await response.json();
            // data.statusã‚’è¡¨ç¤º
            console.log(`${NODE[i]}`, data.status);

            if (data.status.apiNode === 'up' && data.status.db === 'up') {   // apiNode ã¨ dbã€€ãŒ æ­£å¸¸ã®å ´åˆ
              return NODE[i];   // ãƒãƒ¼ãƒ‰ã®å€¤ã‚’è¿”ã™
              break;
            }
          }
        } catch (error) {
          // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          console.error(`Node Error!! ==> ${NODE[i]}`, error);
        }
      }
      removeLoading()
      //ã€€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
      swal(`Active Node Error!!`, `ã‚µã‚¤ãƒˆç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„
      X(Twitter): @mikunNEM`)
    }

    function searchArray(array, searchString) {  // é…åˆ—ã‹ã‚‰ç‰¹å®šã®æ–‡å­—åˆ—ã‚’æ¢ã—ã€è¦‹ã¤ã‹ã‚Œã°ã€€true ã‚’è¿”ã™
      for (let i = 0; i < array.length; i++) {
        if (array[i] === searchString) {
          return true;
        }
      }
      return false;
    }

    ////////////////////////////////////////////////
    // ã‚¯ãƒ«ã‚¯ãƒ«å›ã‚‹gif ã‚’è¡¨ç¤º
    ////////////////////////////////////////////////
    /* ------------------------------
     è¡¨ç¤ºç”¨ã®é–¢æ•°
     ------------------------------ */

    function dispLoading(msg) {    //
      // å¼•æ•°ãªã—ã®å ´åˆã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯éè¡¨ç¤ºã€‚
      if (msg === undefined) msg = "";

      // ç”»é¢è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åŸ‹ã‚è¾¼ã¿
      var innerMsg = "<div id='innerMsg_re'>" + msg + "</div>";

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»åƒãŒéè¡¨ç¤ºã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ã—ã€éè¡¨ç¤ºã®å ´åˆã®ã¿å‡ºåŠ›ã€‚
      if ($("#nowLoading_re").length == 0) {
        $("#kurukuru_re").append("<div id='nowLoading_re'>" + innerMsg + "</div>");
      }
    }

    /* ------------------------------
     è¡¨ç¤ºã‚¹ãƒˆãƒƒãƒ—ç”¨ã®é–¢æ•°
     ------------------------------ */

    function removeLoading() {  //
      $("#nowLoading_re").remove();
    }

    async function delegate_list(URL, data2, sym, networkType) {

      let address_list = [];  // å§”ä»»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒˆ
      let address_from_pubkey;
      for (let i = 0; i < data2.unlockedAccount.length; i++) {    // ãƒªãƒ³ã‚¯ã•ã‚ŒãŸå…¬é–‹éµã‹ã‚‰Symbolã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›ã—ã¦ãƒªã‚¹ãƒˆã«ã™ã‚‹                           

        fetch(`${URL}/accounts/${data2.unlockedAccount[i]}`)
          .then((response) => {
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæˆåŠŸã—ãŸã‹ã©ã†ã‹ã‚’ç¢ºèª
            if (!response.ok) {
              throw new Error(`Network response was not ok: ${response.status}`);
            }
            // JSONãƒ‡ãƒ¼ã‚¿ã‚’è§£æã—ã¦è¿”ã™
            return response.json();
          })
          .then((data) => {
            address_from_pubkey = sym.PublicAccount.createFromPublicKey(
              data.account.supplementalPublicKeys.linked.publicKey,
              networkType
            );
            address_list.push(address_from_pubkey.address.address);
            // console.log("å§”ä»»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ===",address_list);                                                                                                                            
          })
          .catch((error) => {
            console.error("Fetch error:", error);
          });
        await new Promise(resolve => setTimeout(resolve, 20)); // 0.02ç§’å‡¦ç†ã‚’æ­¢ã‚ã‚‹                                                                
      }
    }

  </script>

</body>

</html>